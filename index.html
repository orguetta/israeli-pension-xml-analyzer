<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מנתח XML פנסיוני ישראלי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            text-align: right;
            font-family: 'Inter', sans-serif;
        }
        .drag-active {
            border-color: #4f46e5 !important;
            background-color: rgba(79, 70, 229, 0.1) !important;
        }
        #chart-container {
            min-height: 300px; 
            height: 350px; 
            position: relative; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .fas {
            margin-left: 0.5rem; 
            margin-right: 0;
        }
        .btn-icon .fas {
             margin-left: 0.5rem; 
        }
        #drop-area .fa-file-upload {
             margin-left: 0; 
        }
        .file-item-icon {
            margin-left: 0.75rem;
            margin-right: 0;
        }
        .file-item-status-icon {
            margin-right: 0.5rem; 
            margin-left: 0;
        }
        table th, table td {
            text-align: right;
            white-space: nowrap; 
        }
        table th.truncate-text, table td.truncate-text {
            white-space: normal; 
        }

        .chartjs-legend ul {
            direction: rtl;
        }
        .chartjs-legend li {
            text-align: right;
        }
        .chartjs-legend li span {
            float: right;
            margin-left: 5px;
            margin-right: 0;
        }
        .button-base {
            @apply px-4 py-2 font-medium rounded-lg text-sm transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .button-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500;
        }
        .button-secondary {
            @apply bg-green-500 hover:bg-green-600 text-white focus:ring-green-500;
        }
        .button-tertiary {
            @apply bg-teal-500 hover:bg-teal-600 text-white focus:ring-teal-500;
        }
        .button-ai {
            @apply bg-purple-500 hover:bg-purple-600 text-white text-xs px-2 py-1 rounded-md;
        }
        #processing-indicator {
            display: none; 
            text-align: center;
            padding: 1rem;
            color: #4f46e5; 
            font-weight: 500;
        }
        #no-data-message {
             display: none; 
             text-align: center;
             padding: 2rem;
             margin-top:1rem;
             background-color: #fff;
             border: 1px dashed #d1d5db;
             border-radius: 0.5rem;
             color: #6b7280;
        }
        .summary-card-original { /* For original summary boxes */
            @apply p-5 rounded-lg border text-center;
        }
        .summary-card-original .label {
            @apply text-sm font-medium mb-1;
        }
        .summary-card-original .value {
             @apply text-2xl md:text-3xl font-bold break-all;
        }

        /* Modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content {
            background-color: #fefefe;
            padding: 25px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 650px; 
            border-radius: 8px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-close {
            color: #aaa;
            float: left; 
            font-size: 32px;
            font-weight: bold;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-body {
            min-height: 100px; 
            max-height: 70vh; 
            overflow-y: auto;
            padding-top: 10px;
            line-height: 1.7; 
            text-align: right; 
        }
        .modal-body h4 { 
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 0.75em;
            margin-bottom: 0.25em;
        }
        .modal-body ul, .modal-body ol {
            margin-right: 1.5em; 
            margin-bottom: 0.75em;
        }
        .modal-body li {
            margin-bottom: 0.3em;
        }
        .modal-disclaimer {
            @apply mt-6 pt-4 border-t border-gray-300 text-xs text-gray-500 text-center;
        }

        .modal-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }


        @media print {
            body {
                font-size: 8pt; 
                margin: 0;
                padding: 0 !important; 
                background-color: white !important;
                font-family: 'Arial', sans-serif; 
            }
            header, section.mb-12, footer, #export-buttons, #drop-area button, #fileList, #processing-indicator, #no-data-message, .modal, .ai-analysis-column, #api-key-section { 
                display: none !important;
            }
            #results-container, #results-container > div {
                display: block !important; 
                box-shadow: none !important;
                border: none !important;
                margin-bottom: 5px !important; 
            }
            .container {
                max-width: 100% !important;
                padding: 5px !important; 
            }
            #chart-container {
                min-height: 200px !important; 
                height: auto !important; 
                page-break-inside: avoid;
            }
            canvas#pieChart {
                max-width: 100% !important;
                max-height: 250px !important; 
            }
             .grid, .grid-cols-1, .md\:grid-cols-3, .lg\:grid-cols-2, .xl\:grid-cols-1 { 
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important; 
            }
            .summary-card-print { 
                page-break-inside: avoid;
                padding: 5px !important;
                border: 1px solid #eee !important;
            }
            .summary-card-print .label {
                font-size: 8pt !important;
                margin-bottom: 2px !important;
            }
             .summary-card-print .value {
                font-size: 10pt !important; 
                font-weight: bold;
            }
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: auto;
                 font-size: 7pt; 
            }
            th, td {
                border: 1px solid #ccc !important;
                padding: 2px !important; 
            }
            thead {
                display: table-header-group !important; 
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .bg-white { background-color: white !important; }
            .p-6 { padding: 0 !important; }
            .mb-8 { margin-bottom: 0.5cm !important; } 
            h1 { font-size: 16pt !important; }
            h2 { font-size: 12pt !important; page-break-after: avoid; }
            .text-lg { font-size: 10pt !important; } 
            .text-base { font-size: 9pt !important; }


            .chartjs-legend {
                font-size: 7pt !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-full xl:max-w-7xl"> 
        <header class="mb-10 text-center"> <!-- Increased bottom margin for header -->
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-700 mb-3">מנתח XML פנסיוני ישראלי</h1>
            <h3 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4">מבית Finely</h3>
            <p class="text-gray-600 max-w-2xl mx-auto text-lg">העלה קובץ XML אחד או יותר מהמסלקה הפנסיונית כדי לנתח את הקרנות, דמי הניהול ומסלולי ההשקעה שלך. כעת עם ניתוחי AI ✨!</p>
        </header>

        <section class="mb-12 bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
            <div id="drop-area">
                <div class="text-center py-10 px-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-colors duration-200">
                    <i class="fas fa-cloud-upload-alt text-5xl text-indigo-500 mb-4"></i>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-2">העלאת קובצי XML פנסיוניים</h2>
                    <p class="text-gray-500 mb-6">גרור ושחרר את הקבצים שלך לכאן או לחץ לבחירה</p>
                    <input type="file" id="fileInput" class="hidden" accept=".xml" multiple>
                    <button id="browseBtn" class="button-base button-primary btn-icon">
                        <i class="fas fa-folder-open"></i>בחר קבצים
                    </button>
                </div>
                <div id="fileList" class="mt-6 space-y-3"></div>
                <div id="processing-indicator">
                    <i class="fas fa-spinner fa-spin mr-2"></i>מעבד קבצים, נא להמתין...
                </div>
            </div>
        </section>
         <div id="no-data-message">
            לא נמצאו נתונים להצגה בקבצים שסופקו, או שהקבצים אינם מכילים מידע פנסיוני רלוונטי בפורמט הנתמך.
        </div>

        <div id="results-container" class="fade-in" style="display: none;">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 sm:mb-0">סיכום כולל</h2>
                    <div id="export-buttons" class="flex space-x-2 space-x-reverse">
                         <button id="printPdfBtn" class="button-base button-secondary btn-icon">
                            <i class="fas fa-print"></i>הדפס/ייצא ל-PDF
                        </button>
                        <button id="exportCsvBtn" class="button-base button-tertiary btn-icon">
                            <i class="fas fa-file-csv"></i>ייצא טבלה ל-CSV
                        </button>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-center summary-card-print">
                        <p class="text-sm text-blue-600 font-medium label">יתרה כוללת</p>
                        <p id="total-balance" class="text-2xl font-bold text-blue-700 value">₪0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-center summary-card-print">
                        <p class="text-sm text-green-600 font-medium label">ספקים</p>
                        <p id="total-providers" class="text-2xl font-bold text-green-700 value">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 text-center summary-card-print">
                        <p class="text-sm text-purple-600 font-medium label">מוצרים/חשבונות</p>
                        <p id="total-products" class="text-2xl font-bold text-purple-700 value">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">התפלגות נכסים לפי סוג מוצר</h2>
                <div id="chart-container" class="relative w-full">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">פירוט חשבונות/קרנות</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">ספק</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">שם התוכנית</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">סוג מוצר</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">יתרה</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">מסלול השקעה</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">ד"נ הפקדה (נטו)</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">ד"נ צבירה שנתית (נטו)</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">תוקף הטבה ד"נ</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">הפקדה אחרונה</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">ת. הפקדה אחרונה</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">שכר להפקדה אחרונה</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider ai-analysis-column">ניתוח AI</th>
                            </tr>
                        </thead>
                        <tbody id="funds-table-body" class="bg-white divide-y divide-gray-200">
                            <tr id="no-data-table-row" style="display: none;">
                                <td colspan="12" class="px-6 py-10 text-center text-gray-500">לא נמצאו נתונים להצגה.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- API Key Input Section - Moved before footer -->
        <section id="api-key-section" class="mt-12 mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <label for="apiKeyInput" class="text-sm font-medium text-gray-700 shrink-0">מפתח Google AI API:</label>
                <input type="password" id="apiKeyInput" class="flex-grow p-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="הדבק כאן את מפתח ה-API שלך">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-sm text-indigo-600 hover:text-indigo-800 underline whitespace-nowrap">
                    <i class="fas fa-key mr-1"></i>קבל מפתח API מ-Google AI Studio
                </a>
            </div>
            <p class="text-xs text-gray-500 mt-2">המפתח נשאר בדפדפן שלך בלבד ומשמש רק לקריאות ישירות ל-Google API. אם השדה ריק, יכולות הAI יהיו לא פעילים.</p>
        </section>

        <!-- Modal for AI Analysis -->
        <div id="aiAnalysisModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" id="modalCloseBtn">&times;</span>
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800 mb-4">ניתוח Gemini AI</h3>   
                <div id="modalBody" class="modal-body">
                     <div class="modal-loader">
                        <i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i>
                    </div>
                </div>
            </div>
        </div>


        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p> כל העיבוד מתבצע בדפדפן שלך - שום מידע אינו נשלח לשרת כלשהו רק ביכולות הAI.</p>
            <p class="mt-2">© 2025 Finely. פותח למטרות הדגמה ושימוש אישי.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const fileInput = document.getElementById('fileInput');
            const dropArea = document.getElementById('drop-area');
            const browseBtn = document.getElementById('browseBtn');
            const fileList = document.getElementById('fileList');
            const resultsContainer = document.getElementById('results-container');
            const fundsTableBody = document.getElementById('funds-table-body');
            const totalBalanceEl = document.getElementById('total-balance');
            const totalProvidersEl = document.getElementById('total-providers');
            const totalProductsEl = document.getElementById('total-products');
            const printPdfBtn = document.getElementById('printPdfBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const processingIndicator = document.getElementById('processing-indicator');
            const noDataTableMessage = document.getElementById('no-data-table-row');
            const generalNoDataMessage = document.getElementById('no-data-message');
            const aiAnalysisModal = document.getElementById('aiAnalysisModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const apiKeyInput = document.getElementById('apiKeyInput'); 
            
            // Global state
            let pieChart = null;
            let allFundData = []; 

            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.font.size = 12; 
            Chart.defaults.color = '#374151'; 

            initEmptyChart(); 

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                const directChildDiv = dropArea.querySelector('div:first-child');
                if (directChildDiv) {
                    directChildDiv.classList.add('drag-active');
                }
            }

            function unhighlight() {
                const directChildDiv = dropArea.querySelector('div:first-child');
                if (directChildDiv) {
                    directChildDiv.classList.remove('drag-active');
                }
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles({target: {files}}); 
            }

            dropArea.addEventListener('drop', handleDrop, false);
            browseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFiles);
            printPdfBtn.addEventListener('click', () => window.print());
            exportCsvBtn.addEventListener('click', exportTableToCSV);
            modalCloseBtn.addEventListener('click', () => aiAnalysisModal.style.display = "none");
            window.addEventListener('click', function(event) {
                if (event.target == aiAnalysisModal) {
                    aiAnalysisModal.style.display = "none";
                }
            });


            function handleFiles(e) {
                const files = Array.from(e.target.files || []);
                if (files.length === 0) return;

                fileList.innerHTML = ''; 
                allFundData = []; 
                resultsContainer.style.display = 'none';
                generalNoDataMessage.style.display = 'none';
                noDataTableMessage.style.display = 'none';
                processingIndicator.style.display = 'block'; 

                let filesToProcess = files.length;

                files.forEach(file => {
                    if (file.type !== 'text/xml' && !file.name.endsWith('.xml')) {
                        showFileInList(file, 'error', 'אינו קובץ XML.');
                        filesToProcess--;
                        checkCompletion();
                        return;
                    }
                    const initialFileItem = showFileInList(file, 'processing');
                    parseXMLFile(file, (success, message, fundDataListFromFile) => {
                        filesToProcess--;
                        if (success) {
                            if (fundDataListFromFile && fundDataListFromFile.length > 0) {
                                showFileInList(file, 'success', `חולצו ${fundDataListFromFile.length} רשומות.`, initialFileItem);
                            } else {
                                showFileInList(file, 'warning', 'לא חולץ מידע פנסיוני רלוונטי מהקובץ.', initialFileItem);
                            }
                        } else {
                            showFileInList(file, 'error', message, initialFileItem);
                        }
                        checkCompletion();
                    });
                });

                function checkCompletion() {
                    if (filesToProcess === 0) {
                        processingIndicator.style.display = 'none';
                        if (allFundData.length > 0) {
                            updateResultsUI();
                        } else {
                            console.log("לא חולצו נתונים מאף קובץ XML תקין, או שהקבצים לא הכילו מידע רלוונטי.");
                            if(pieChart) pieChart.destroy(); 
                            initEmptyChart(); 
                            resultsContainer.style.display = 'none';
                            generalNoDataMessage.style.display = 'block';
                            noDataTableMessage.style.display = 'table-row';
                        }
                    }
                }
            }

            function showFileInList(file, status, message = '', existingItem = null) {
                let fileItem = existingItem;
                if (!fileItem) {
                    fileItem = document.createElement('div');
                    fileItem.dataset.fileName = file.name; 
                    fileList.appendChild(fileItem);
                }
                let bgColor, borderColor, iconClass, iconColor, statusText;
                switch(status) {
                    case 'success':
                        bgColor = 'bg-green-50'; borderColor = 'border-green-300'; iconClass = 'fa-check-circle'; iconColor = 'text-green-600'; statusText = message || 'עובד בהצלחה';
                        break;
                    case 'error':
                        bgColor = 'bg-red-50'; borderColor = 'border-red-300'; iconClass = 'fa-times-circle'; iconColor = 'text-red-600'; statusText = message || 'שגיאה בעיבוד';
                        break;
                    case 'warning': 
                        bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-300'; iconClass = 'fa-exclamation-triangle'; iconColor = 'text-yellow-600'; statusText = message || 'אזהרה';
                        break;
                    case 'processing':
                    default:
                        bgColor = 'bg-blue-50'; borderColor = 'border-blue-300'; iconClass = 'fa-spinner fa-spin'; iconColor = 'text-blue-600'; statusText = 'מעבד...';
                        break;
                }
                fileItem.className = `flex items-center p-3 rounded-md border ${bgColor} ${borderColor}`;
                fileItem.innerHTML = `
                    <i class="fas ${iconClass} ${iconColor} file-item-icon text-lg"></i>
                    <div class="flex-1 truncate mr-3">
                        <p class="text-sm font-medium text-gray-800 truncate">${file.name}</p>
                        <p class="text-xs ${status === 'error' ? 'text-red-700' : (status === 'warning' ? 'text-yellow-700' : 'text-gray-500')}">${formatFileSize(file.size)}${statusText ? ` - ${statusText}` : ''}</p>
                    </div>`;
                return fileItem; 
            }

            function formatFileSize(bytes) { 
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function parseXMLFile(file, callback) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let success = false;
                    let message = '';
                    let fundDataListFromFile = [];
                    try {
                        const xmlString = e.target.result;
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                        
                        const parseError = xmlDoc.querySelector('parsererror');
                        if (parseError) {
                            message = 'מבנה XML לא תקין.';
                            console.error('שגיאה בניתוח קובץ XML:', file.name, parseError.textContent);
                            callback(false, message, null);
                            return;
                        }
                        
                        fundDataListFromFile = extractDataFromXML(xmlDoc); 
                        if (fundDataListFromFile.length > 0) {
                           allFundData.push(...fundDataListFromFile); 
                           success = true;
                        } else {
                            success = true; 
                        }
                    } catch (error) {
                        message = 'שגיאה פנימית בעיבוד הקובץ.';
                        console.error('שגיאה בעיבוד הקובץ:', file.name, error);
                    }
                    callback(success, message, fundDataListFromFile); 
                };
                reader.onerror = function() {
                    callback(false, 'שגיאה בקריאת הקובץ.', null);
                };
                reader.readAsText(file);
            }

            function getProductType(productTypeCode) {
                const code = String(productTypeCode).trim();
                const productMap = {
                    '1': 'ביטוח חיים/מנהלים',
                    '2': 'קרן פנסיה',
                    '3': 'קופת גמל',
                    '4': 'קרן השתלמות',
                    '5': 'קופת גמל להשקעה',
                    '14': 'פוליסת חיסכון'
                };
                return productMap[code] || 'אחר';
            }

            function getText(node, query, defaultValue = '') {
                const el = node.querySelector(query);
                return el && el.textContent ? el.textContent.trim() : defaultValue;
            }

            function getFloat(node, query, defaultValue = 0) {
                const el = node.querySelector(query);
                return el && el.textContent ? parseFloat(el.textContent.trim()) : defaultValue;
            }
            
            function formatDate(yyyymmdd) {
                if (!yyyymmdd || yyyymmdd.length < 8) return '-';
                const year = yyyymmdd.substring(0, 4);
                const month = yyyymmdd.substring(4, 6);
                const day = yyyymmdd.substring(6, 8);
                if (day === '00') return `${month}/${year}`; 
                return `${day}/${month}/${year}`;
            }
            
            function formatYearMonth(yyyymm) {
                if (!yyyymm || yyyymm.length < 6) return '-';
                const year = yyyymm.substring(0, 4);
                const month = yyyymm.substring(4, 6);
                return `${month}/${year}`;
            }

            let fundCounter = 0; 

            function extractDataFromXML(xmlDoc) {
                const funds = [];
                let providerNameNode = xmlDoc.querySelector('YeshutYatzran > SHEM-YATZRAN');
                if (!providerNameNode || !providerNameNode.textContent.trim()) { 
                    providerNameNode = xmlDoc.querySelector('KoteretKovetz > SHEM-SHOLEACH');
                }
                const providerName = providerNameNode ? providerNameNode.textContent.trim() : 'ספק לא ידוע';
            
                const mutzarim = xmlDoc.querySelectorAll('Mutzarim > Mutzar');
                
                mutzarim.forEach(mutzarNode => {
                    const sugMutzarNode = mutzarNode.querySelector('NetuneiMutzar > SUG-MUTZAR');
                    const productTypeCode = sugMutzarNode ? sugMutzarNode.textContent.trim() : null;
                    const genericProductType = getProductType(productTypeCode); 

                    const accounts = mutzarNode.querySelectorAll('HeshbonotOPolisot > HeshbonOPolisa');
                    accounts.forEach(accountNode => {
                        const fundId = `fund-${fundCounter++}`; 
                        const productDisplayName = getText(accountNode, 'SHEM-TOCHNIT', genericProductType);
                        let currentBalance = 0;
                        const pirteiTaktzivNodes = accountNode.querySelectorAll('PirteiTaktziv');
                        pirteiTaktzivNodes.forEach(taktzivNode => {
                            const blockItrot = taktzivNode.querySelector('BlockItrot > Yitrot');
                            if (blockItrot) {
                                const perutYitrotNodes = blockItrot.querySelectorAll('PerutYitrot > TOTAL-CHISACHON-MTZBR');
                                perutYitrotNodes.forEach(yitraNode => {
                                    currentBalance += parseFloat(yitraNode.textContent) || 0;
                                });
                            }
                            if (currentBalance === 0) {
                                const masluleiHashkaaBalanceNodes = taktzivNode.querySelectorAll('PerutMasluleiHashkaa > SCHUM-TZVIRA-BAMASLUL');
                                masluleiHashkaaBalanceNodes.forEach(schumNode => {
                                    currentBalance += parseFloat(schumNode.textContent) || 0;
                                });
                            }
                        });

                        let depositFee = 0;
                        let balanceFeeAnnual = 0; 
                        let effectiveDepositFee = 0;
                        let effectiveBalanceFeeAnnual = 0;
                        let feeBenefitEndDate = '-';
                        let trackName = 'ברירת מחדל';
                        
                        let lastDepositDate = '-';
                        let lastDepositAmount = 0;
                        let lastDepositSalaryMonth = '-';

                        const firstPirteiTaktziv = accountNode.querySelector('PirteiTaktziv');
                        if (firstPirteiTaktziv) {
                            const hotzaotNode = firstPirteiTaktziv.querySelector('PerutHotzaot > HotzaotBafoalLehodeshDivoach');
                            const mivneDmeiNihulNodes = firstPirteiTaktziv.querySelectorAll('PerutHotzaot > MivneDmeiNihul > PerutMivneDmeiNihul');

                            if (hotzaotNode) {
                                depositFee = getFloat(hotzaotNode, 'SHEUR-DMEI-NIHUL-HAFKADA');
                                const balanceFeeMonthly = getFloat(hotzaotNode, 'SHEUR-DMEI-NIHUL-TZVIRA');
                                balanceFeeAnnual = parseFloat((balanceFeeMonthly * 12).toFixed(4));
                            }
                            
                            effectiveDepositFee = depositFee;
                            effectiveBalanceFeeAnnual = balanceFeeAnnual;

                            mivneDmeiNihulNodes.forEach(mivneNode => {
                                const sugHotzaa = getText(mivneNode, 'SUG-HOTZAA');
                                const sheurDmeiNihulBase = getFloat(mivneNode, 'SHEUR-DMEI-NIHUL');
                                const kayemetHatava = getText(mivneNode, 'KAYEMET-HATAVA') === '1';

                                if (kayemetHatava) {
                                    const achozHatava = getFloat(mivneNode, 'ACHOZ-HATAVA');
                                    const sheurDmeiNihulEffective = sheurDmeiNihulBase * (1 - (achozHatava / 100));
                                    const endDate = formatDate(getText(mivneNode, 'TAARICH-SIUM-HATAVA'));
                                    if (endDate !== '-') feeBenefitEndDate = endDate; 

                                    if (sugHotzaa === '1') { 
                                         effectiveBalanceFeeAnnual = parseFloat(sheurDmeiNihulEffective.toFixed(4));
                                    } else if (sugHotzaa === '2') { 
                                        effectiveDepositFee = parseFloat(sheurDmeiNihulEffective.toFixed(4));
                                    }
                                } else { 
                                    if (sugHotzaa === '1') effectiveBalanceFeeAnnual = parseFloat(sheurDmeiNihulBase.toFixed(4));
                                    else if (sugHotzaa === '2') effectiveDepositFee = parseFloat(sheurDmeiNihulBase.toFixed(4));
                                }
                            });


                            const trackNode = firstPirteiTaktziv.querySelector('PerutMasluleiHashkaa > SHEM-MASLUL-HASHKAA');
                            if (trackNode) {
                                trackName = trackNode.textContent.trim() || 'ברירת מחדל';
                            }

                            const hafkadaAchronaBlock = firstPirteiTaktziv.querySelector('PirteiHafkadaAchrona > PerutPirteiHafkadaAchrona');
                            if (hafkadaAchronaBlock) {
                                lastDepositDate = formatYearMonth(getText(hafkadaAchronaBlock, 'TAARICH-HAFKADA-ACHARON'));
                                lastDepositAmount = getFloat(hafkadaAchronaBlock, 'TOTAL-HAFKADA-ACHRONA');
                                const chodeshSacharNode = hafkadaAchronaBlock.querySelector('PerutHafkadaAchrona > CHODESH-SACHAR');
                                if(chodeshSacharNode && chodeshSacharNode.textContent){
                                    lastDepositSalaryMonth = formatYearMonth(chodeshSacharNode.textContent.trim());
                                }
                            }
                        }
                        
                        if (currentBalance > 0 || (genericProductType !== 'אחר' && productDisplayName !== 'אחר')) {
                            funds.push({
                                id: fundId, 
                                provider: providerName,
                                productDisplayName: productDisplayName,
                                productType: genericProductType,
                                balance: currentBalance,
                                depositFee: depositFee, 
                                balanceFee: balanceFeeAnnual,
                                effectiveDepositFee: effectiveDepositFee,
                                effectiveBalanceFee: effectiveBalanceFeeAnnual,
                                feeBenefitEndDate: feeBenefitEndDate,
                                trackName: trackName,
                                lastDepositDate: lastDepositDate,
                                lastDepositAmount: lastDepositAmount,
                                lastDepositSalaryMonth: lastDepositSalaryMonth
                            });
                        }
                    });
                });
                return funds;
            }

            function updateResultsUI() {
                 if (allFundData.length === 0) {
                    resultsContainer.style.display = 'none';
                    generalNoDataMessage.style.display = 'block';
                    noDataTableMessage.style.display = 'table-row';
                    if(pieChart) pieChart.destroy();
                    initEmptyChart();
                    return;
                }
                resultsContainer.style.display = 'block';
                generalNoDataMessage.style.display = 'none';
                noDataTableMessage.style.display = 'none';
                
                const totalBalance = allFundData.reduce((sum, fund) => sum + fund.balance, 0);
                const uniqueProviders = [...new Set(allFundData.map(fund => fund.provider))];
                const uniqueProductDisplayNames = [...new Set(allFundData.map(fund => fund.productDisplayName))];
                
                totalBalanceEl.textContent = `₪${totalBalance.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                totalProvidersEl.textContent = uniqueProviders.length;
                totalProductsEl.textContent = uniqueProductDisplayNames.length;
                
                requestAnimationFrame(() => {
                    updateFundsTable();
                    updateChart(); 
                });
            }

            function updateFundsTable() {
                fundsTableBody.innerHTML = ''; 
                if (allFundData.length === 0) {
                    noDataTableMessage.style.display = 'table-row';
                    return;
                }
                noDataTableMessage.style.display = 'none';

                allFundData.sort((a, b) => b.balance - a.balance)
                    .forEach(fund => {
                        const row = fundsTableBody.insertRow();
                        row.className = 'hover:bg-gray-50 transition-colors duration-150 text-sm';
                        
                        row.insertCell().textContent = fund.provider;
                        row.cells[0].className = 'px-4 py-2 font-medium text-gray-800';
                        
                        row.insertCell().textContent = fund.productDisplayName;
                        row.cells[1].className = 'px-4 py-2 text-gray-600';

                        row.insertCell().textContent = fund.productType;
                        row.cells[2].className = 'px-4 py-2 text-gray-600';
                        
                        row.insertCell().textContent = `₪${fund.balance.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        row.cells[3].className = 'px-4 py-2 text-gray-800 font-semibold';
                                               
                        row.insertCell().textContent = fund.trackName;
                        row.cells[4].className = 'px-4 py-2 text-gray-600 truncate max-w-xs';
                        
                        row.insertCell().textContent = `${(fund.effectiveDepositFee).toFixed(4)}%`;
                        row.cells[5].className = 'px-4 py-2 text-gray-600';

                        row.insertCell().textContent = `${(fund.effectiveBalanceFee).toFixed(4)}%`;
                        row.cells[6].className = 'px-4 py-2 text-gray-600';
                        
                        row.insertCell().textContent = fund.feeBenefitEndDate;
                        row.cells[7].className = 'px-4 py-2 text-gray-600';

                        row.insertCell().textContent = `₪${fund.lastDepositAmount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        row.cells[8].className = 'px-4 py-2 text-gray-600';
                        
                        row.insertCell().textContent = fund.lastDepositDate;
                        row.cells[9].className = 'px-4 py-2 text-gray-600';
                        
                        row.insertCell().textContent = fund.lastDepositSalaryMonth;
                        row.cells[10].className = 'px-4 py-2 text-gray-600';

                        const aiCell = row.insertCell();
                        aiCell.className = 'px-4 py-2 text-center space-y-1 ai-analysis-column';

                        const analyzeFeesBtn = document.createElement('button');
                        analyzeFeesBtn.innerHTML = `<i class="fas fa-percentage mr-1"></i> ✨ נתח ד"נ`;
                        analyzeFeesBtn.className = 'button-ai w-full mb-1';
                        analyzeFeesBtn.onclick = () => handleAiAnalysis('fees', fund.id);
                        aiCell.appendChild(analyzeFeesBtn);

                        const explainTrackBtn = document.createElement('button');
                        explainTrackBtn.innerHTML = `<i class="fas fa-route mr-1"></i> ✨ הסבר מסלול`;
                        explainTrackBtn.className = 'button-ai w-full';
                        explainTrackBtn.onclick = () => handleAiAnalysis('track', fund.id);
                        aiCell.appendChild(explainTrackBtn);
                    });
            }

            function formatGeminiResponse(text) {
                let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/_(.*?)_/g, '<em>$1</em>');

                const lines = html.split('\n');
                let inList = false;
                let listType = ''; 
                let processedHtml = '';

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return; 

                    const listItemMatch = line.match(/^(\*|-|\d+\.)\s+(.*)/);
                    if (listItemMatch) {
                        const itemContent = listItemMatch[2];
                        const marker = listItemMatch[1];
                        
                        if (!inList) { 
                            listType = (marker === '*' || marker === '-') ? 'ul' : 'ol';
                            processedHtml += `<${listType} class="list-disc list-inside mr-4 mb-2">`;
                            inList = true;
                        } else if ((listType === 'ul' && (marker !== '*' && marker !== '-')) || (listType === 'ol' && !marker.match(/^\d+\./))) {
                            processedHtml += `</${listType}>`;
                            listType = (marker === '*' || marker === '-') ? 'ul' : 'ol';
                            processedHtml += `<${listType} class="list-disc list-inside mr-4 mb-2">`;
                        }
                        processedHtml += `<li>${itemContent}</li>`;
                    } else {
                        if (inList) { 
                            processedHtml += `</${listType}>`;
                            inList = false;
                        }
                        if (line.startsWith('<strong>') && line.endsWith('</strong>') && line.length < 100) { 
                             processedHtml += `<h4 class="text-md font-semibold mt-3 mb-1">${line.replace(/<\/?strong>/g, '')}</h4>`;
                        } else {
                            processedHtml += `<p class="mb-2">${line}</p>`;
                        }
                    }
                });

                if (inList) { 
                    processedHtml += `</${listType}>`;
                }
                return processedHtml;
            }

            async function callGeminiAPI(prompt) {
                modalBody.innerHTML = `<div class="modal-loader"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i></div>`;
                aiAnalysisModal.style.display = "flex"; 

                let userApiKey = apiKeyInput.value.trim(); 
                let finalApiKey = userApiKey ? userApiKey : ""; 

                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${finalApiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gemini API Error:", errorData);
                        throw new Error(`שגיאת API: ${response.status} ${response.statusText}. ${errorData?.error?.message || ''}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        const formattedContent = formatGeminiResponse(text);
                        const disclaimer = `<div class="modal-disclaimer"><p><strong>לתשומת לבך:</strong> המידע המוצג כאן הוא ניתוח כללי המבוסס על נתונים מוגבלים ואינו מהווה ייעוץ פנסיוני, פיננסי או תחליף לייעוץ מקצועי מיועץ מוסמך. המידע ניתן למטרות אינפורמטיביות בלבד.</p></div>`;
                        modalBody.innerHTML = `<div class="prose prose-sm max-w-none rtl">${formattedContent}</div>${disclaimer}`;
                    } else {
                        console.error("Unexpected Gemini API response structure:", result);
                        throw new Error("תשובת API לא צפויה או ריקה.");
                    }
                } catch (error) {
                    console.error("שגיאה בקריאה ל-Gemini API:", error);
                    modalBody.innerHTML = `<p class="text-red-600">אירעה שגיאה: ${error.message}</p><p>אנא בדוק את חיבור האינטרנט שלך או נסה שוב מאוחר יותר.</p>`;
                }
            }


            function handleAiAnalysis(type, fundId) {
                const fund = allFundData.find(f => f.id === fundId);
                if (!fund) {
                    console.error("Fund not found for AI analysis:", fundId);
                    modalTitle.textContent = "שגיאה";
                    modalBody.innerHTML = "<p>הקרן המבוקשת לא נמצאה.</p>";
                    aiAnalysisModal.style.display = "flex";
                    return;
                }

                let prompt = "";
                if (type === 'fees') {
                    modalTitle.textContent = `ניתוח דמי ניהול עבור: ${fund.productDisplayName}`;
                    prompt = `
                    נתח את דמי הניהול הבאים עבור מוצר פנסיוני מסוג "${fund.productType}" בישראל. 
                    שם התוכנית: ${fund.productDisplayName}.
                    דמי ניהול מהפקדה (נטו): ${fund.effectiveDepositFee}%.
                    דמי ניהול שנתיים מהצבירה (נטו): ${fund.effectiveBalanceFee}%.
                    תוקף הטבה בדמי ניהול: ${fund.feeBenefitEndDate}.

                    בעברית פשוטה וללא הקדמות מיותרות או הצגה עצמית, אנא ספק:
                    1. הערכה האם דמי ניהול אלו גבוהים, נמוכים או ממוצעים ביחס לשוק בישראל עבור סוג מוצר זה.
                    2. נקודות עיקריות לשים לב אליהן (כגון תוקף הטבה).
                    3. המלצות כלליות לבדיקה נוספת (לא ייעוץ פיננסי אישי).

                    הצג את התשובה כטקסט פשוט, ללא סימני Markdown אם אפשר, והתמקד בתשובה הישירה ללא הקדמות על תפקידך.
                    `;
                } else if (type === 'track') {
                    modalTitle.textContent = `הסבר על מסלול השקעה: ${fund.trackName}`;
                    prompt = `
                    הסבר בעברית פשוטה על מסלול השקעה בשם "${fund.trackName}". 
                    סוג המוצר הפנסיוני הוא "${fund.productType}".

                    ללא הקדמות מיותרות או הצגה עצמית, אנא ספק:
                    1. מאפיינים עיקריים של מסלול כזה (סוגי נכסים).
                    2. רמת סיכון כללית אופיינית.
                    3. למי בדרך כלל מתאים מסלול כזה.

                    הצג את התשובה כטקסט פשוט, ללא סימני Markdown אם אפשר, והתמקד בתשובה הישירה ללא הקדמות על תפקידך.
                    `;
                }
                callGeminiAPI(prompt);
            }



            function initEmptyChart() {
                const ctx = document.getElementById('pieChart').getContext('2d');
                if (pieChart) {
                    pieChart.destroy();
                }
                pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['אין נתונים'],
                        datasets: [{
                            data: [100],
                            backgroundColor: ['#e5e7eb'], 
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                   padding: 20, 
                                   boxWidth: 15,
                                   font: { size: 13 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ₪0.00`;
                                    }
                                },
                                titleFont: { weight: 'bold', size: 14 },
                                bodyFont: { size: 13 },
                                padding: 10,
                                displayColors: true,
                                boxPadding: 4
                            }
                        }
                    }
                });
            }

            function updateChart() {
                const ctx = document.getElementById('pieChart').getContext('2d');
                if (!ctx) {
                    console.error("Canvas context for pieChart not found.");
                    return;
                }

                if (pieChart) {
                    pieChart.destroy(); 
                }

                if (!allFundData || allFundData.length === 0) {
                    initEmptyChart(); 
                    return;
                }

                const productGroups = {};
                allFundData.forEach(fund => {
                    if (!productGroups[fund.productType]) { 
                        productGroups[fund.productType] = 0;
                    }
                    productGroups[fund.productType] += fund.balance;
                });
                
                const productTypesForChart = Object.keys(productGroups);
                const productBalancesForChart = Object.values(productGroups);
                
                const backgroundColors = [ 
                    '#4f46e5', '#059669', '#d97706', '#9333ea', '#db2777', 
                    '#dc2626', '#6d28d9', '#c026d3', '#ea580c', '#0891b2',
                    '#7c3aed', '#047857' 
                ].slice(0, productTypesForChart.length);
                
                pieChart = new Chart(ctx, { 
                    type: 'pie',
                    data: {
                        labels: productTypesForChart,
                        datasets: [{
                            data: productBalancesForChart,
                            backgroundColor: backgroundColors,
                            borderColor: '#ffffff', 
                            borderWidth: 2,
                            hoverOffset: 8 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                   padding: 20, 
                                   boxWidth: 15,
                                   font: { size: 13 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; 
                                        return `${label}: ₪${value.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${percentage}%)`;
                                    }
                                },
                                titleFont: { weight: 'bold', size: 14 },
                                bodyFont: { size: 13 },
                                padding: 10,
                                displayColors: true,
                                boxPadding: 4
                            }
                        }
                    }
                });
            }

            function exportTableToCSV() {
                if (allFundData.length === 0) {
                    alert('אין נתונים לייצוא.');
                    return;
                }

                const headers = [
                    'ספק', 'שם התוכנית', 'סוג מוצר', 'יתרה (₪)', 'מסלול השקעה', 
                    'ד"נ הפקדה נטו (%)', 'ד"נ צבירה שנתית נטו (%)', 'תוקף הטבה ד"נ',
                    'סכום הפקדה אחרונה (₪)', 'תאריך הפקדה אחרונה', 'חודש שכר להפקדה אחרונה'
                ];
                const csvRows = [];
                csvRows.push(headers.join(','));

                allFundData.forEach(fund => {
                    const row = [
                        `"${fund.provider.replace(/"/g, '""')}"`, 
                        `"${fund.productDisplayName.replace(/"/g, '""')}"`,
                        `"${fund.productType.replace(/"/g, '""')}"`,
                        fund.balance.toFixed(2),
                        `"${fund.trackName.replace(/"/g, '""')}"`,
                        fund.effectiveDepositFee.toFixed(4),
                        fund.effectiveBalanceFee.toFixed(4),
                        `"${fund.feeBenefitEndDate.replace(/"/g, '""')}"`,
                        fund.lastDepositAmount.toFixed(2),
                        `"${fund.lastDepositDate.replace(/"/g, '""')}"`,
                        `"${fund.lastDepositSalaryMonth.replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvString = "\uFEFF" + csvRows.join('\n'); 

                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'נתוני_פנסיה_מפורט.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('ייצוא ל-CSV אינו נתמך בדפדפן זה.');
                }
            }

        });
    </script>
</body>
</html>
